{% extends "base.html" %}

{% block title %}è³‡ç”£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}

{% block extra_styles %}
<style>
    .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 12px 0;
    }
    
    .header-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        flex: 1;
        text-align: center;
    }
    
    .icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        color: #333;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .refresh-icon {
        width: 24px;
        height: 24px;
        transition: transform 0.3s ease;
    }
    
    .icon-btn:active .refresh-icon {
        animation: rotate 0.6s ease-in-out;
    }
    
    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .summary-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }

    @media (min-width: 992px) {
        .summary-grid {
            grid-template-columns: 1fr 1fr;
            align-items: stretch;
        }
    }
    
    .total-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .total-label {
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
    }
    
    .total-amount {
        font-size: 36px;
        font-weight: 700;
        color: #333;
        margin-bottom: 12px;
        letter-spacing: -0.5px;
    }
    
    .total-profit {
        font-size: 20px;
        font-weight: 600;
        padding: 8px 20px;
        background: #f8f8f8;
        border-radius: 20px;
        display: inline-block;
    }

    .profit-percentage {
        font-size: 16px;
        opacity: 0.8;
        margin-left: 8px;
    }

    .chart-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        min-height: 250px;
        position: relative;
    }
    
    .profit-plus { color: #dc3545; }
    .profit-minus { color: #28a745; }
    
    .asset-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
    }
    
    .asset-card {
        background: white;
        border-radius: 16px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.15s ease;
        text-decoration: none;
        color: inherit;
        display: block;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .asset-card:active {
        transform: scale(0.97);
        box-shadow: 0 1px 4px rgba(0,0,0,0.12);
    }
    
    .card-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 12px;
        font-size: 20px;
    }
    
    .card-name {
        font-size: 13px;
        color: #666;
        margin-bottom: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .card-amount {
        font-size: 20px;
        font-weight: 600;
        color: #333;
    }
    
    .card-detail {
        font-size: 11px;
        color: #999;
        margin-top: 4px;
    }
    
    .card-profit {
        font-size: 14px;
        font-weight: 600;
        margin-top: 8px;
    }

    .card-profit-percentage {
        font-size: 12px;
        opacity: 0.8;
    }
    
    @media (min-width: 768px) {
        .asset-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    
    @media (min-width: 1024px) {
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .asset-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="header-bar">
    <form method="post" action="{{ url_for('update_all_prices') }}" style="margin: 0;">
        <button type="submit" class="icon-btn" onclick="return confirm('å…¨ã¦ã®ä¾¡æ ¼ã‚’æ‰‹å‹•ã§æ›´æ–°ã—ã¾ã™ã‹?æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')">
            <svg class="refresh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        </button>
    </form>
    <div class="header-title">ã‚ˆã†ã“ã {{ user_name }}ã•ã‚“</div>
    <a href="{{ url_for('logout') }}" class="icon-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
    </a>
</div>

<div class="summary-grid">
    <div class="total-card">
        <div class="total-label">ç·è³‡ç”£</div>
        <div class="total-amount">Â¥{{ "{:,.0f}".format(total_assets) }}</div>
        {% set total_cost = (jp_total - jp_profit) + (us_total_jpy - us_profit_jpy) + (gold_total - gold_profit) + (crypto_total - crypto_profit) + (investment_trust_total - investment_trust_profit) + (insurance_total - insurance_profit) %}
        {% set total_profit_rate = (total_profit / total_cost * 100) if total_cost > 0 else 0 %}
        <div class="total-profit {% if total_profit >= 0 %}profit-plus{% else %}profit-minus{% endif %}">
            {% if total_profit >= 0 %}+{% endif %}Â¥{{ "{:,.0f}".format(total_profit) }}
            <span class="profit-percentage">({% if total_profit >= 0 %}+{% endif %}{{ "{:.2f}".format(total_profit_rate) }}%)</span>
        </div>
    </div>
    <div class="chart-card">
        <canvas id="assetPieChart"></canvas>
    </div>
</div>

<div class="chart-card" style="margin-bottom: 24px; height: 400px;">
    <canvas id="assetHistoryChart"></canvas>
</div>

<div class="asset-grid">
    <a href="{{ url_for('manage_assets', asset_type='jp_stock') }}" class="asset-card">
        <div class="card-icon" style="background: #e8f5e9;">ğŸ‡¯ğŸ‡µ</div>
        <div class="card-name">æ—¥æœ¬æ ª</div>
        <div class="card-amount">Â¥{{ "{:,.0f}".format(jp_total) }}</div>
        <div class="card-detail">{{ jp_stocks|length }} éŠ˜æŸ„</div>
        {% set jp_cost = jp_total - jp_profit %}
        {% set jp_profit_rate = (jp_profit / jp_cost * 100) if jp_cost > 0 else 0 %}
        <div class="card-profit {% if jp_profit >= 0 %}profit-plus{% else %}profit-minus{% endif %}">
            {% if jp_profit >= 0 %}+{% endif %}Â¥{{ "{:,.0f}".format(jp_profit) }}
            <div class="card-profit-percentage">({% if jp_profit >= 0 %}+{% endif %}{{ "{:.2f}".format(jp_profit_rate) }}%)</div>
        </div>
    </a>
    
    <a href="{{ url_for('manage_assets', asset_type='us_stock') }}" class="asset-card">
        <div class="card-icon" style="background: #e3f2fd;">ğŸ‡ºğŸ‡¸</div>
        <div class="card-name">ç±³å›½æ ª</div>
        <div class="card-amount">Â¥{{ "{:,.0f}".format(us_total_jpy) }}</div>
        <div class="card-detail">${{ "{:,.2f}".format(us_total_usd) }} ({{ us_stocks|length }} éŠ˜æŸ„)</div>
        {% set us_cost_jpy = us_total_jpy - us_profit_jpy %}
        {% set us_profit_rate = (us_profit_jpy / us_cost_jpy * 100) if us_cost_jpy > 0 else 0 %}
        <div class="card-profit {% if us_profit_jpy >= 0 %}profit-plus{% else %}profit-minus{% endif %}">
            {% if us_profit_jpy >= 0 %}+{% endif %}Â¥{{ "{:,.0f}".format(us_profit_jpy) }}
            <div class="card-profit-percentage">({% if us_profit_jpy >= 0 %}+{% endif %}{{ "{:.2f}".format(us_profit_rate) }}%)</div>
        </div>
    </a>
    
    <a href="{{ url_for('manage_assets', asset_type='cash') }}" class="asset-card">
        <div class="card-icon" style="background: #fff3e0;">ğŸ’°</div>
        <div class="card-name">ç¾é‡‘</div>
        <div class="card-amount">Â¥{{ "{:,.0f}".format(cash_total) }}</div>
        <div class="card-detail">{{ cash_items|length }} é …ç›®</div>
    </a>
    
    <a href="{{ url_for('manage_assets', asset_type='gold') }}" class="asset-card">
        <div class="card-icon" style="background: #fffde7;">ğŸ¥‡</div>
        <div class="card-name">é‡‘ (Gold)</div>
        <div class="card-amount">Â¥{{ "{:,.0f}".format(gold_total) }}</div>
        <div class="card-detail">{{ gold_items|length }} é …ç›®</div>
        {% set gold_cost = gold_total - gold_profit %}
        {% set gold_profit_rate = (gold_profit / gold_cost * 100) if gold_cost > 0 else 0 %}
        <div class="card-profit {% if gold_profit >= 0 %}profit-plus{% else %}profit-minus{% endif %}">
            {% if gold_profit >= 0 %}+{% endif %}Â¥{{ "{:,.0f}".format(gold_profit) }}
            <div class="card-profit-percentage">({% if gold_profit >= 0 %}+{% endif %}{{ "{:.2f}".format(gold_profit_rate) }}%)</div>
        </div>
    </a>
    
    <a href="{{ url_for('manage_assets', asset_type='crypto') }}" class="asset-card">
        <div class="card-icon" style="background: #f3e5f5;">â‚¿</div>
        <div class="card-name">æš—å·è³‡ç”£</div>
        <div class="card-amount">Â¥{{ "{:,.0f}".format(crypto_total) }}</div>
        <div class="card-detail">{{ crypto_items|length }} é …ç›®</div>
        {% set crypto_cost = crypto_total - crypto_profit %}
        {% set crypto_profit_rate = (crypto_profit / crypto_cost * 100) if crypto_cost > 0 else 0 %}
        <div class="card-profit {% if crypto_profit >= 0 %}profit-plus{% else %}profit-minus{% endif %}">
            {% if crypto_profit >= 0 %}+{% endif %}Â¥{{ "{:,.0f}".format(crypto_profit) }}
            <div class="card-profit-percentage">({% if crypto_profit >= 0 %}+{% endif %}{{ "{:.2f}".format(crypto_profit_rate) }}%)</div>
        </div>
    </a>

    <a href="{{ url_for('manage_assets', asset_type='investment_trust') }}" class="asset-card">
        <div class="card-icon" style="background: #e0f2f1;">ğŸ“ˆ</div>
        <div class="card-name">æŠ•è³‡ä¿¡è¨—</div>
        <div class="card-amount">Â¥{{ "{:,.0f}".format(investment_trust_total) }}</div>
        <div class="card-detail">{{ investment_trust_items|length }} éŠ˜æŸ„</div>
        {% set it_cost = investment_trust_total - investment_trust_profit %}
        {% set it_profit_rate = (investment_trust_profit / it_cost * 100) if it_cost > 0 else 0 %}
        <div class="card-profit {% if investment_trust_profit >= 0 %}profit-plus{% else %}profit-minus{% endif %}">
            {% if investment_trust_profit >= 0 %}+{% endif %}Â¥{{ "{:,.0f}".format(investment_trust_profit) }}
            <div class="card-profit-percentage">({% if investment_trust_profit >= 0 %}+{% endif %}{{ "{:.2f}".format(it_profit_rate) }}%)</div>
        </div>
    </a>

    <a href="{{ url_for('manage_assets', asset_type='insurance') }}" class="asset-card">
        <div class="card-icon" style="background: #e0f7fa;">ğŸ›¡ï¸</div>
        <div class="card-name">ä¿é™º</div>
        <div class="card-amount">Â¥{{ "{:,.0f}".format(insurance_total) }}</div>
        <div class="card-detail">{{ insurance_items|length }} ä»¶</div>
        {% set insurance_cost = insurance_total - insurance_profit %}
        {% set insurance_profit_rate = (insurance_profit / insurance_cost * 100) if insurance_cost > 0 else 0 %}
        <div class="card-profit {% if insurance_profit >= 0 %}profit-plus{% else %}profit-minus{% endif %}">
            {% if insurance_profit >= 0 %}+{% endif %}Â¥{{ "{:,.0f}".format(insurance_profit) }}
            <div class="card-profit-percentage">({% if insurance_profit >= 0 %}+{% endif %}{{ "{:.2f}".format(insurance_profit_rate) }}%)</div>
        </div>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<script>
// ãƒ©ãƒ™ãƒ«è¡¨ç¤ºç”¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’Chart.jsã«ç™»éŒ²
Chart.register(ChartDataLabels);

document.addEventListener('DOMContentLoaded', function() {
    const chartDataJSON = '{{ chart_data | safe }}';
    const historyDataJSON = '{{ history_data | safe }}';

    // å††ã‚°ãƒ©ãƒ•ã¨æ£’ã‚°ãƒ©ãƒ•ã§å…±é€šã®ã€æ–°ã—ã„é®®ã‚„ã‹ãªè‰²è¨­å®š
    const assetColors = [
        '#E63946', // æ—¥æœ¬æ ª (Vibrant Red)
        '#457B9D', // ç±³å›½æ ª (Vibrant Blue)
        '#F4A261', // ç¾é‡‘ (Vibrant Orange)
        '#E9C46A', // é‡‘ (Vibrant Yellow)
        '#9B5DE5', // æš—å·è³‡ç”£ (Vibrant Purple)
        '#52B788', // æŠ•è³‡ä¿¡è¨— (Vibrant Green)
        '#F15BB5'  // ä¿é™º (Vibrant Pink)
    ];

    // è³‡ç”£ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªå††ã‚°ãƒ©ãƒ•
    if (chartDataJSON) {
        const chartData = JSON.parse(chartDataJSON);
        
        const filteredLabels = [];
        const filteredValues = [];
        const filteredColors = [];
        chartData.values.forEach((value, index) => {
            if (value > 0) {
                filteredLabels.push(chartData.labels[index]);
                filteredValues.push(value);
                filteredColors.push(assetColors[index]);
            }
        });

        if (filteredValues.length > 0) {
            const ctxPie = document.getElementById('assetPieChart').getContext('2d');
            new Chart(ctxPie, {
                type: 'pie',
                data: {
                    labels: filteredLabels,
                    datasets: [{
                        data: filteredValues,
                        backgroundColor: filteredColors,
                        borderColor: '#fff',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        // å¾“æ¥ã®å‡¡ä¾‹ã¯éè¡¨ç¤ºã«ã™ã‚‹
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'è³‡ç”£ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª',
                            font: { size: 16 }
                        },
                        // ã‚°ãƒ©ãƒ•å†…ã«ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®è¨­å®š
                        datalabels: {
                            formatter: (value, context) => {
                                const datapoints = context.chart.data.datasets[0].data;
                                const total = datapoints.reduce((total, datapoint) => total + datapoint, 0);
                                const percentage = (value / total) * 100;
                                // å‰²åˆãŒå°ã•ã™ãã‚‹ãƒ©ãƒ™ãƒ«ã¯éè¡¨ç¤ºã«ã—ã¦è¦‹ã‚„ã™ãã™ã‚‹
                                if (percentage < 3) {
                                    return '';
                                }
                                const label = context.chart.data.labels[context.dataIndex];
                                return `${percentage.toFixed(2)}%\n${label}`;
                            },
                            color: '#fff',
                            textAlign: 'center',
                            font: {
                                weight: 'bold',
                                size: 12,
                            },
                            // æ–‡å­—ã«å½±ã‚’ä»˜ã‘ã¦èª­ã¿ã‚„ã™ãã™ã‚‹
                            textShadowBlur: 6,
                            textShadowColor: 'rgba(0, 0, 0, 0.5)'
                        },
                        tooltip: {
                             callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    const value = context.parsed;
                                    label += new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(value);
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    // è³‡ç”£æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆç©ã¿ä¸Šã’æ£’ã‚°ãƒ©ãƒ•ï¼‰
    if (historyDataJSON) {
        const historyData = JSON.parse(historyDataJSON);
        if (historyData.dates && historyData.dates.length > 0) {
            const ctxHistory = document.getElementById('assetHistoryChart').getContext('2d');
            
            // â˜…â˜…â˜… æ£’ã‚°ãƒ©ãƒ•ã‚’æ¥µé™ã¾ã§ç´°ãã™ã‚‹ãŸã‚ã®è¨­å®š â˜…â˜…â˜…
            const barThicknessOptions = {
                barPercentage: 0.2, // ã‚«ãƒ†ã‚´ãƒªå†…ã®æ£’ãŒå ã‚ã‚‹å‰²åˆï¼ˆå€¤ã‚’å°ã•ãã—ã¦ç´°ãã—ã¾ã—ãŸï¼‰
                categoryPercentage: 0.5 // ã‚«ãƒ†ã‚´ãƒªå…¨ä½“ãŒå ã‚ã‚‹å‰²åˆï¼ˆå€¤ã‚’å°ã•ãã—ã¦é–“éš”ã‚’åºƒã’ã¾ã—ãŸï¼‰
            };

            new Chart(ctxHistory, {
                type: 'bar',
                data: {
                    labels: historyData.dates,
                    datasets: [
                        { label: 'æ—¥æœ¬æ ª', data: historyData.jp_stock, backgroundColor: assetColors[0], ...barThicknessOptions },
                        { label: 'ç±³å›½æ ª', data: historyData.us_stock, backgroundColor: assetColors[1], ...barThicknessOptions },
                        { label: 'ç¾é‡‘', data: historyData.cash, backgroundColor: assetColors[2], ...barThicknessOptions },
                        { label: 'é‡‘', data: historyData.gold, backgroundColor: assetColors[3], ...barThicknessOptions },
                        { label: 'æš—å·è³‡ç”£', data: historyData.crypto, backgroundColor: assetColors[4], ...barThicknessOptions },
                        { label: 'æŠ•è³‡ä¿¡è¨—', data: historyData.investment_trust, backgroundColor: assetColors[5], ...barThicknessOptions },
                        { label: 'ä¿é™º', data: historyData.insurance, backgroundColor: assetColors[6], ...barThicknessOptions }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'è³‡ç”£æ¨ç§»', font: { size: 16 } },
                        tooltip: { 
                            mode: 'nearest', 
                            intersect: true 
                        },
                        legend: { position: 'bottom' },
                        // æ£’ã‚°ãƒ©ãƒ•ã§ã¯ãƒ©ãƒ™ãƒ«è¡¨ç¤ºãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç„¡åŠ¹åŒ–
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        x: { stacked: true },
                        y: {
                            stacked: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 100000000) return 'Â¥' + (value / 100000000).toFixed(1) + 'å„„';
                                    if (value >= 10000) return 'Â¥' + (value / 10000).toLocaleString() + 'ä¸‡';
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
    }
});
</script>
{% endblock %}
